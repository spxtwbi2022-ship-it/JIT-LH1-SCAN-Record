<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æƒç®±ç³»çµ±</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body{font-family:system-ui, -apple-system, 'Noto Sans TC', sans-serif; padding:12px}
#controls{display:flex; gap:8px; margin-bottom:8px}
#log{white-space:pre-wrap; max-height:200px; overflow:auto; background:#f7f7f7; padding:8px}
button{padding:8px 12px}
</style>
</head>
<body>
<h2>å¸æ©Ÿæƒç®±ç³»çµ±</h2>

<div id="controls">
<label>Driver ID: <input id="driverId" placeholder="è¼¸å…¥å¸æ©Ÿç·¨è™Ÿ" /></label>
<!-- <label>Seller: <select id="seller" placeholder="è³£å®¶åç¨±/ç·¨è™Ÿ (å¯é¸)" /></label> -->
<label>Seller: 
    <select id="seller">
        <option value="">-- è¼‰å…¥ä¸­... --</option>
    </select>
</label>
<button id="btnStart">å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
<button id="btnStop">åœæ­¢</button>
<button id="btnSync">ç«‹å³ä¸Šå‚³</button>
</div>


<div id="qr-reader" style="width:100%; max-width:480px; margin-bottom:8px"></div>
<div id="status">å°šæœªé–‹å§‹æƒæ</div>
<h4>æƒæç´€éŒ„ï¼ˆsessionï¼‰</h4>
<h4>ç•¶å‰ä½œæ¥­ç¸½è¨ˆï¼š<span id="totalCount">0</span> ç­†</h4>
<table id="scanTable" style="width:100%; border-collapse: collapse; margin-bottom: 12px; border: 1px solid #ccc;">
    <thead>
        <tr style="background: #e7e7e7;">
            <th style="padding: 4px; border: 1px solid #ccc;">#</th>
            <th style="padding: 4px; border: 1px solid #ccc;">æƒæç·¨è™Ÿ (QR Code)</th>
            <th style="padding: 4px; border: 1px solid #ccc;">ç‹€æ…‹</th> </tr>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>
<div id="log"></div>

<script src="config.js"></script>
<script>
// CONFIG from config.js: GAS_ENDPOINT, BATCH_SIZE, BATCH_TIMEOUT_MS
const driverInput = document.getElementById('driverId');
// const sellerInput = document.getElementById('seller');
const sellerSelect = document.getElementById('seller');
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const btnSync = document.getElementById('btnSync');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');

// æƒæç›¸é—œè®Šæ•¸
const totalCountEl = document.getElementById('totalCount');
const scanTableBody = document.querySelector('#scanTable tbody');

let html5QrScanner = null;
let buffer = []; // æœªé€å‡ºçš„æƒæè³‡æ–™
let sending = false;
let timerId = null;
let isScanning = false; // ã€æ–°å¢æ——æ¨™ã€‘è¿½è¹¤æ˜¯å¦æ­£åœ¨æƒæ

// è¼‰å…¥ local cache çš„æœªé€å‡ºè³‡æ–™
const LOCAL_KEY = 'qr_scan_offline_buffer_v1';
function loadLocalBuffer(){
    try{
        const raw = localStorage.getItem(LOCAL_KEY);
        if(raw){ 
            buffer = JSON.parse(raw); 

            // ã€ä¿®å¾©é»ï¼šå¼·åˆ¶æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§ã€‘
            // å¦‚æœ buffer åŒ…å«ä»»ä½•ä¸æ˜¯ç‰©ä»¶çš„å…ƒç´ ï¼Œæˆ–è€…é•·åº¦ç‚ºé›¶ï¼Œå°±æ¸…é™¤å®ƒã€‚
            if (buffer.length === 0 || typeof buffer[0] !== 'object' || buffer[0] === null) {
                buffer = [];
                localStorage.removeItem(LOCAL_KEY); // æ¸…é™¤æå£çš„ç·©å­˜
                appendLog('âš ï¸ åµæ¸¬åˆ°ç„¡æ•ˆç·©å­˜ï¼Œå·²æ¸…é™¤ï¼');
                updateScanList(); 
                return;
            }
            
            appendLog(`å¾ localStorage è¼‰å…¥ ${buffer.length} ç­†`); 
        }
    }catch(e){ 
        console.error(e);
        // å¦‚æœ JSON.parse å¤±æ•— (æ•¸æ“šæå£)ï¼Œæ¸…é™¤ç·©å­˜
        buffer = [];
        localStorage.removeItem(LOCAL_KEY); 
        appendLog('âš ï¸ localStorage æ•¸æ“šè§£æå¤±æ•—ï¼Œå·²æ¸…é™¤ï¼');
    }
    
    // ã€ä¿®æ”¹é»ã€‘è¼‰å…¥ç·©å­˜å¾Œæ›´æ–°åˆ—è¡¨
    updateScanList(); 
}

    
function saveLocalBuffer(){ localStorage.setItem(LOCAL_KEY, JSON.stringify(buffer)); }


function appendLog(text){
logEl.textContent = new Date().toLocaleTimeString() + ' - ' + text + '\n' + logEl.textContent;
}

function updateScanList(){
    // æ›´æ–°ç¸½è¨ˆ
    totalCountEl.textContent = buffer.length;

    // æ¸…ç©ºè¡¨æ ¼
    scanTableBody.innerHTML = ''; 
    
    // éæ­· bufferï¼Œå¾æœ€æ–°æƒæçš„é–‹å§‹é¡¯ç¤º (åå‘)
    for(let i = buffer.length - 1; i >= 0; i--){
        const item = buffer[i];
        const row = scanTableBody.insertRow();
        row.insertCell().textContent = i + 1; // åºè™Ÿ
        row.insertCell().textContent = item.code; // QR Code ç·¨è™Ÿ

        // ã€æ–°å¢æ¨™è¨˜é‚è¼¯ã€‘å¦‚æœå·²ä¸Šå‚³ï¼Œå‰‡æ”¹è®Šæ¨£å¼
        if(item.sent){
            row.style.backgroundColor = '#d4edda'; // æ·ºç¶ è‰²èƒŒæ™¯
            row.insertCell().textContent = 'âœ… å·²ä¸Šå‚³';
        } else {
            row.insertCell().textContent = 'â³ å¾…ä¸Šå‚³';
        }
    }
}

function enqueue(code){
    const item = {
        code: code,
        driver: driverInput.value || 'unknown',
        seller: sellerSelect.value || '',
        ts: new Date().toISOString()
    };
    // simple session dedupe
    const last = buffer[buffer.length-1];
    if(last && last.code === item.code)
        { appendLog('å¿½ç•¥é‡è¤‡æƒæ: '+item.code); 
         return; 
    }
    buffer.push(item);
    saveLocalBuffer();
    // appendLog('åŠ å…¥ buffer: '+code+' (buffer='+buffer.length+')'); // èˆŠæ—¥èªŒå¯è¨»è§£æ‰
    appendLog(`ğŸŸ¢ æƒåˆ°: ${code}`); // æ–°æ—¥èªŒé¡¯ç¤º
    
    // ã€ä¿®æ”¹é»ã€‘å‘¼å«æ›´æ–°åˆ—è¡¨
    updateScanList();
    
    // è‡ªå‹•ä¸Šå‚³
    if(buffer.length >= BATCH_SIZE) sendBatch();
}

async function sendBatch(){
    if(sending) return;
    if(buffer.length === 0) return;
    if(!navigator.onLine){ appendLog('é›¢ç·šï¼Œæš«ä¸é€å‡º'); return; }
        
    sending = true;
    const batch = buffer.slice(0, BATCH_SIZE);
    try{
    const resp = await fetch(GAS_ENDPOINT, {
    method: 'POST',
    // headers: {'Content-Type': 'application/json'},
    headers: {'Content-Type': 'text/plain'},
    body: JSON.stringify({ records: batch, api_key: API_KEY || '' })
    });
    
    // ã€âœ… æ–°å¢æª¢æŸ¥ã€‘å³ä½¿è«‹æ±‚æˆåŠŸï¼Œä¹Ÿè¦ç¢ºä¿ç‹€æ…‹ç¢¼æ˜¯ 200
    if (!resp.ok) {
        // å¦‚æœç‹€æ…‹ç¢¼æ˜¯ 4xx/5xxï¼Œé¡¯ç¤ºå…·é«”ç‹€æ…‹ç¢¼
        const errorText = await resp.text();
        throw new Error(`HTTP éŒ¯èª¤: ${resp.status} - ${errorText.substring(0, 50)}`);
    }
    
    const j = await resp.json();
    if(j.status === 'ok'){
        // â¬‡ï¸ é—œéµä¿®æ”¹ï¼šä¸å¾ buffer ä¸­ç§»é™¤å·²ä¸Šå‚³çš„ batch æ•¸æ“š

        // å°‡å·²ä¸Šå‚³çš„é …ç›®æ¨™è¨˜ç‚º 'SENT'
        for(let i = 0; i < batch.length; i++){
            // æ‰¾åˆ° buffer ä¸­å°æ‡‰çš„é …ç›®ï¼Œä¸¦æ·»åŠ  sent å±¬æ€§
            buffer[i].sent = true; 
        }
        
        // buffer = buffer.slice(batch.length);
        
        // ç”±æ–¼æˆ‘å€‘ä¸å†ç§»é™¤æ•¸æ“šï¼Œå› æ­¤æ•´å€‹ buffer ä¿æŒä¸è®Šï¼Œåªéœ€æ›´æ–°æœ¬åœ°å„²å­˜
        saveLocalBuffer();

        // â¬‡ï¸ ä¿®æ”¹é€™è£¡ï¼šè¨ˆç®—çœŸæ­£æœªä¸Šå‚³çš„å‰©é¤˜ç­†æ•¸
        const remainingToUpload = buffer.filter(item => !item.sent).length;
        
        // appendLog('ä¸Šå‚³æˆåŠŸ, å‰©é¤˜ buffer='+buffer.length); // â¬…ï¸ åŸæœ¬é€™è¡Œæ˜¯éŒ¯çš„ï¼Œå› ç‚º buffer.length åŒ…å«å·²ä¸Šå‚³çš„
        appendLog(`âœ… ä¸Šå‚³æˆåŠŸ, å¾…ä¸Šå‚³: ${remainingToUpload} ç­† (ç¸½ç´€éŒ„æ•¸: ${buffer.length})`); // ä¿®æ­£å¾Œçš„æ—¥èªŒ

        // â¬‡ï¸ æˆåŠŸä¸Šå‚³å¾Œï¼Œç«‹å³æ›´æ–°åˆ—è¡¨ä»¥é¡¯ç¤ºç‹€æ…‹æ¨™è¨˜
        updateScanList();
        
    } else {
    appendLog('å¾Œç«¯å›å‚³éŒ¯èª¤: '+JSON.stringify(j));
    }
    }catch(err){
    // ã€âœ… ä¿®æ­£æ—¥èªŒã€‘é¡¯ç¤ºå…·é«”çš„éŒ¯èª¤åç¨±å’Œè¨Šæ¯
    appendLog(`ğŸ”´ ä¸Šå‚³å¤±æ•—ï¼Œç¨å¾Œé‡è©¦ã€‚éŒ¯èª¤é¡å‹: ${err.name} - ${err.message}`); 
    console.error(err); 
    }
    sending = false;
}

â¬‡ï¸ å®šæ™‚ä¸Šå‚³
function startBatchTimer(){
stopBatchTimer();
timerId = setInterval(()=>{ sendBatch(); }, BATCH_TIMEOUT_MS);
}
function stopBatchTimer(){ if(timerId) clearInterval(timerId); timerId=null; }

// ã€æ–°å¢å‡½å¼ã€‘ å¾ GAS ç²å–è³£å®¶æ¸…å–®ä¸¦å¡«å……ä¸‹æ‹‰é¸å–®
async function loadSellers() { // å‡½å¼åç¨±æ”¹ç‚º loadSellers
    appendLog('å˜—è©¦è¼‰å…¥è³£å®¶æ¸…å–®...');
    try {
        // ä½¿ç”¨ doGet æ¥å£ï¼Œæ–°å¢ action åƒæ•¸
        const sellerEndpoint = GAS_ENDPOINT + '?action=getSellers'; // è®Šæ•¸åç¨±èˆ‡ action åƒæ•¸ä¿®æ”¹
        const resp = await fetch(sellerEndpoint);
        
        // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
        if (!resp.ok) {
            throw new Error(`HTTP éŒ¯èª¤: ${resp.status}`);
        }
        
        const j = await resp.json();
        
        // æ¸…ç©ºä¸‹æ‹‰é¸å–®
        sellerSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡è³£å®¶ --</option>'; 

        if (j.status === 'ok' && j.sellers && j.sellers.length > 0) {
            j.sellers.forEach(seller => { // éæ­·è®Šæ•¸åç¨±ä¿®æ”¹
                const option = document.createElement('option');
                option.value = seller;
                option.textContent = seller;
                sellerSelect.appendChild(option);
            });
            appendLog(`æˆåŠŸè¼‰å…¥ ${j.sellers.length} å€‹è³£å®¶`);
        } else {
            // å¦‚æœæ¸…å–®ç‚ºç©ºæˆ–éŒ¯èª¤
            appendLog('è³£å®¶æ¸…å–®è¼‰å…¥å¤±æ•—æˆ–ç‚ºç©º: ' + (j.message || 'è«‹ç¢ºèª GAS è¨­ç½®'));
        }
    } catch (err) {
        appendLog('è¼‰å…¥è³£å®¶æ¸…å–®æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤');
        console.error(err);
        sellerSelect.innerHTML = '<option value="">-- è¼‰å…¥éŒ¯èª¤ --</option>'; 
    }
}

btnStart.addEventListener('click', ()=>{
// ã€èª¿æ•´æª¢æŸ¥é‚è¼¯ã€‘ å¿…é ˆåŒæ™‚è¼¸å…¥ Driver ID ä¸”é¸æ“‡ Seller
if(!driverInput.value){ 
    alert('è«‹è¼¸å…¥ Driver ID'); 
    return; 
}
if(!sellerSelect.value){ 
    alert('è«‹é¸æ“‡è³£å®¶ Seller'); 
    return; 
}
if(html5QrScanner) return;
html5QrScanner = new Html5Qrcode("qr-reader");
html5QrScanner.start({ facingMode: 'environment' }, {
    fps: 10,
    qrbox: {width:250, height:250}
}, (decodedText, decodedResult)=>{
    statusEl.textContent = 'æƒåˆ°: '+decodedText;
    enqueue(decodedText);
}, (errorMessage) => {
    // parse errors or no result
}).then(()=>{
    appendLog('ç›¸æ©Ÿå•Ÿå‹•'); 
    statusEl.textContent='æƒæä¸­...';
    isScanning = true; // ã€ä¿®æ”¹é»ã€‘å•Ÿå‹•æƒæ
    btnSync.disabled = true; // ã€ä¿®æ”¹é»ã€‘æƒæå•Ÿå‹•æ™‚ç¦ç”¨ä¸Šå‚³
}).catch(err=>{ alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: '+err); });

startBatchTimer();
});

btnStop.addEventListener('click', ()=>{
    if(html5QrScanner){
        html5QrScanner.stop().then(()=>{
            html5QrScanner.clear(); 
            html5QrScanner=null; 
            appendLog('ç›¸æ©Ÿå·²åœæ­¢'); 
            statusEl.textContent='å·²åœæ­¢';
            isScanning = false; // ã€ä¿®æ”¹é»ã€‘åœæ­¢æƒæ
            btnSync.disabled = false; // ã€ä¿®æ”¹é»ã€‘åœæ­¢å¾Œå•Ÿç”¨ä¸Šå‚³
        }).catch(e=>console.error(e)); }

stopBatchTimer();
});


btnSync.addEventListener('click', ()=>{ 
    // ã€ä¿®æ”¹é»ã€‘å¦‚æœæ­£åœ¨æƒæï¼Œå½ˆå‡ºè­¦å‘Šä¸¦è¿”å›
    if(isScanning){
        alert('è«‹å…ˆé»æ“Šã€Œåœæ­¢ã€æŒ‰éˆ•çµæŸæƒæä½œæ¥­ï¼');
        return;
    }
    sendBatch();
});


// åˆå§‹è¼‰å…¥ï¼š
loadLocalBuffer(); // æ¢å¾©é›¢ç·šç·©å­˜
loadSellers(); // è¼‰å…¥è³£å®¶æ¸…å–®
// è‡ªå‹•é‡è©¦ä¸Šå‚³(ç¶²è·¯å¾©åŸæ™‚)
window.addEventListener('online', ()=>{ appendLog('ç¶²è·¯å›å¾©ï¼Œé–‹å§‹ä¸Šå‚³'); sendBatch(); });
</script>
</body>
</html>

