<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æƒç®±ç³»çµ±</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body{font-family:system-ui, -apple-system, 'Noto Sans TC', sans-serif; padding:12px}
#controls{display:flex; gap:8px; margin-bottom:8px}
#log{white-space:pre-wrap; max-height:200px; overflow:auto; background:#f7f7f7; padding:8px}
button{padding:8px 12px}
</style>
</head>
<body>
<h2>å¸æ©Ÿæƒç®±ç³»çµ±</h2>

<div id="controls">
<!-- <label>Driver ID: <input id="driverId" placeholder="è¼¸å…¥å¸æ©Ÿç·¨è™Ÿ" /></label> -->
<!-- <label>Seller: <select id="seller" placeholder="è³£å®¶åç¨±/ç·¨è™Ÿ (å¯é¸)" /></label> -->
<label>å°ˆè»Šç·¨è™Ÿ: 
    <select id="whTruckNumber">
        <option value="">-- è¼‰å…¥å°ˆè»Šä¸­... --</option>
    </select>
</label>
<label>è³£å®¶åç¨±:Â 
Â  Â  <select id="seller">
Â  Â  Â  Â  <option value="">-- è«‹å…ˆé¸æ“‡å°ˆè»Š --</option>
Â  Â  </select>
</label>
<button id="btnStart">å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
<button id="btnStop">åœæ­¢</button>
<button id="btnSync">ç«‹å³ä¸Šå‚³</button>
</div>


<div id="qr-reader" style="width:100%; max-width:480px; margin-bottom:8px"></div>
<div id="status">å°šæœªé–‹å§‹æƒæ</div>
<h4>æƒæç´€éŒ„ï¼ˆsessionï¼‰</h4>
<!-- <h4>ç•¶å‰ä½œæ¥­ç¸½è¨ˆï¼š<span id="totalCount">0</span> ç­†</h4> -->
<h4>
    ç¸½è¨ˆæƒæï¼š<span id="totalCount">0</span> ç­† | 
    å·²ä¸Šå‚³ï¼š<span id="uploadedCount">0</span> ç­† |
    å¾…ä¸Šå‚³ï¼š<span id="pendingCount">0</span> ç­†
</h4>
<table id="scanTable" style="width:100%; border-collapse: collapse; margin-bottom: 12px; border: 1px solid #ccc;">
    <thead>
        <tr style="background: #e7e7e7;">
            <th style="padding: 4px; border: 1px solid #ccc;">#</th>
            <th style="padding: 4px; border: 1px solid #ccc;">è³£å®¶</th>
            <th style="padding: 4px; border: 1px solid #ccc;">æƒæç·¨è™Ÿ (QR Code)</th>
            <th style="padding: 4px; border: 1px solid #ccc;">ç‹€æ…‹</th> </tr>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>
<div id="log"></div>

<script src="config.js"></script>
<script>
// CONFIG from config.js: GAS_ENDPOINT, BATCH_SIZE, BATCH_TIMEOUT_MS
// const driverInput = document.getElementById('driverId');
// const sellerInput = document.getElementById('seller');
const whTruckNumberSelect = document.getElementById('whTruckNumber'); // ğŸ‘ˆ æ–°å¢å°ˆè»Šä¸‹æ‹‰é¸å–®è®Šæ•¸
const sellerSelect = document.getElementById('seller');
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const btnSync = document.getElementById('btnSync');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');

// æƒæç›¸é—œè®Šæ•¸
const totalCountEl = document.getElementById('totalCount');
const scanTableBody = document.querySelector('#scanTable tbody');

const uploadedCountEl = document.getElementById('uploadedCount'); 
const pendingCountEl = document.getElementById('pendingCount');

// ã€æ–°å¢ã€‘éŸ³æ•ˆç›¸é—œè®Šæ•¸å’Œå‡½å¼
let audio = null;

let html5QrScanner = null;
let buffer = []; // æœªé€å‡ºçš„æƒæè³‡æ–™
let sending = false;
let timerId = null;
let isScanning = false; // ã€æ–°å¢æ——æ¨™ã€‘è¿½è¹¤æ˜¯å¦æ­£åœ¨æƒæ

// è¼‰å…¥ local cache çš„æœªé€å‡ºè³‡æ–™
const LOCAL_KEY = 'qr_scan_offline_buffer_v1';

function updateScanList(){
    // â¬‡ï¸ ã€ä¿®æ”¹é»ã€‘æ–°å¢è¨ˆæ•¸é‚è¼¯
    let uploadedCount = 0;
    
    // æ›´æ–°ç¸½è¨ˆ
    totalCountEl.textContent = buffer.length;

    // æ¸…ç©ºè¡¨æ ¼
    scanTableBody.innerHTML = ''; 
    
    // éæ­· bufferï¼Œå¾æœ€æ–°æƒæçš„é–‹å§‹é¡¯ç¤º (åå‘)
    for(let i = buffer.length - 1; i >= 0; i--){
        const item = buffer[i];
        const row = scanTableBody.insertRow();
        row.insertCell().textContent = i + 1; // åºè™Ÿ
        row.insertCell().textContent = item.seller; // è³£å®¶åç¨±
        row.insertCell().textContent = item.code; // QR Code ç·¨è™Ÿ
        // è™•ç† sent ç‹€æ…‹
        const statusCell = row.insertCell();

        if(item.sent){
            row.style.backgroundColor = '#d4edda'; // æ·ºç¶ è‰²èƒŒæ™¯
            statusCell.textContent = 'âœ… å·²ä¸Šå‚³';
            uploadedCount++; // çµ±è¨ˆå·²ä¸Šå‚³ç­†æ•¸
        } else {
            statusCell.textContent = 'â³ å¾…ä¸Šå‚³';
        }
    }
    // â¬‡ï¸ ã€ä¿®æ”¹é»ã€‘æ›´æ–°ä¸‰å€‹è¨ˆæ•¸å™¨
    uploadedCountEl.textContent = uploadedCount;
    pendingCountEl.textContent = buffer.length - uploadedCount;
}
    
function loadLocalBuffer(){
    try{
        const raw = localStorage.getItem(LOCAL_KEY);
        if(raw){ 
            buffer = JSON.parse(raw); 
            appendLog(`å¾ localStorage è¼‰å…¥ ${buffer.length} ç­†`); 
        }
    }catch(e){ console.error(e);} 
    // ã€ä¿®æ”¹é»ã€‘è¼‰å…¥ç·©å­˜å¾Œæ›´æ–°åˆ—è¡¨
    updateScanList(); 
}

    
function saveLocalBuffer(){ localStorage.setItem(LOCAL_KEY, JSON.stringify(buffer)); }


// function appendLog(text){
// logEl.textContent = new Date().toLocaleTimeString() + ' - ' + text + '\n' + logEl.textContent;
// }
// ã€ä¿®æ­£å€åŸŸ 1: ç¢ºä¿æ—¥èªŒè¼¸å‡ºå®‰å…¨ã€‘
function appendLog(text){
    // é™åˆ¶æ—¥èªŒè¨Šæ¯é•·åº¦ï¼Œé¿å…é¡¯ç¤ºå®Œæ•´çš„ HTML éŒ¯èª¤é é¢
    let safeText = String(text);
    
    // æª¢æŸ¥è¨Šæ¯æ˜¯å¦åƒæ˜¯ HTML å…§å®¹ (ä¾‹å¦‚åŒ…å« <html æˆ– <body ç­‰) æˆ–è¨Šæ¯éé•·ï¼Œé€²è¡Œæˆªæ–·
    if (safeText.includes('<html') || safeText.includes('<body') || safeText.length > 500) {
        safeText = safeText.substring(0, 500) + '... (è¼‰å…¥éŒ¯èª¤è¨Šæ¯éé•·æˆ–åŒ…å« HTML å·²æˆªæ–·)';
    }

    logEl.textContent = new Date().toLocaleTimeString() + ' - ' + safeText + '\n' + logEl.textContent;
}

function enqueue(code){
    // ã€æ–°å¢ã€‘æ’­æ”¾éŸ³æ•ˆ
    playBeep();
    
    // â¬‡ï¸ ã€æ–°å¢ï¼šæª¢æŸ¥æ‰€æœ‰æ­·å²ç´€éŒ„ã€‘
    // ä½¿ç”¨ Array.prototype.some() æª¢æŸ¥ buffer ä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç·¨è™Ÿ (code) çš„ç´€éŒ„
    const isDuplicate = buffer.some(item => item.code === code); 
    
    if(isDuplicate){
        // å¦‚æœç™¼ç¾é‡è¤‡ï¼Œå‰‡è¨˜éŒ„æ—¥èªŒä¸¦é€€å‡ºï¼Œä¸å°‡å…¶åŠ å…¥ buffer
        appendLog(`âš ï¸ å¿½ç•¥é‡è¤‡æƒæ: ${code} (å·²åœ¨æ­·å²ç´€éŒ„ä¸­)`); 
        return; 
    }
    // â¬†ï¸ ã€çµæŸï¼šæª¢æŸ¥æ‰€æœ‰æ­·å²ç´€éŒ„ã€‘
    
    const now = new Date(); // å‰µå»º Date ç‰©ä»¶

    // â¬‡ï¸ ã€é—œéµä¿®æ”¹ã€‘å°‡æ™‚é–“æˆ³ç›´æ¥è½‰æ›æˆæœ¬åœ°æ™‚å€å­—ä¸²
    const localTimeString = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false, // 24 å°æ™‚åˆ¶
        timeZone: 'Asia/Taipei' // ç¢ºä¿æ˜¯å°ç£æ™‚é–“
    });
    
    const item = {
        code: code,
        // driver: driverInput.value || 'unknown',
        // â¬‡ï¸ é€™è£¡ä¿®æ”¹ç‚ºå‚³é€å°ˆè»Šç·¨è™Ÿ
        driver: whTruckNumberSelect.value || 'unknown',
        seller: sellerSelect.value || '',
        // â¬‡ï¸ å°‡ ts æ¬„ä½å„²å­˜ç‚ºæœ¬åœ°åŒ–å­—ä¸² (æ‚¨å¸Œæœ›å¯«å…¥ Sheet çš„æ ¼å¼)
        ts: localTimeString
        // ts: new Date().toISOString()
    };
    // simple session dedupe // ç”±æ–¼æˆ‘å€‘å·²ç¶“æª¢æŸ¥äº†æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä¸éœ€è¦åŸä¾†çš„ "simple session dedupe" æª¢æŸ¥ã€‚
    // const last = buffer[buffer.length-1];
    // if(last && last.code === item.code)
    //     { appendLog('å¿½ç•¥é‡è¤‡æƒæ: '+item.code); 
    //      return; 
    // }
    
    buffer.push(item);
    saveLocalBuffer();
    // appendLog('åŠ å…¥ buffer: '+code+' (buffer='+buffer.length+')'); // èˆŠæ—¥èªŒå¯è¨»è§£æ‰
    appendLog(`ğŸŸ¢ æƒåˆ°: ${code}`); // æ–°æ—¥èªŒé¡¯ç¤º
    
    // ã€ä¿®æ”¹é»ã€‘å‘¼å«æ›´æ–°åˆ—è¡¨
    updateScanList();
    if(buffer.length >= BATCH_SIZE) sendBatch();
}

// ã€æœ€çµ‚ç‰ˆæœ¬ï¼šä¿®å¾©é€£ç™¼ã€æœªå®šç¾©è®Šæ•¸å’Œå‚³é€éŒ¯èª¤ã€‘
async function sendBatch(){
    if(sending) return;
    
    // â¬‡ï¸ ã€æ­¥é©Ÿ 1ï¼šå»ºç«‹åŒ…å«ç´¢å¼•çš„å¾…ä¸Šå‚³æ¸…å–®ã€‘
    const indexedPending = buffer
        .map((item, index) => ({ item, index }))
        .filter(entry => !entry.item.sent);

    // æª¢æŸ¥æ˜¯å¦æœ‰å¾…ä¸Šå‚³è³‡æ–™
    if(indexedPending.length === 0) {
        appendLog('âœ… æ²’æœ‰å¾…ä¸Šå‚³è³‡æ–™ã€‚');
        return; 
    }
    
    if(!navigator.onLine){ appendLog('é›¢ç·šï¼Œæš«ä¸é€å‡º'); return; }
    
    sending = true;
    
    // å¾å¸¶æœ‰ç´¢å¼•çš„å¾…ä¸Šå‚³æ¸…å–®ä¸­å– batch æ‰¹æ¬¡
    const batchEntries = indexedPending.slice(0, BATCH_SIZE); 
    
    // æº–å‚™å‚³é€åˆ°å¾Œç«¯çš„æ•¸æ“š (åªåŒ…å« item)
    const batchToSend = batchEntries.map(entry => entry.item);

    try{
        const resp = await fetch(GAS_ENDPOINT, {
        method: 'POST',
        headers: {'Content-Type': 'text/plain'},
        // å‚³é€æ­£ç¢ºçš„ batchToSend
        body: JSON.stringify({ records: batchToSend, api_key: API_KEY || '' })
    });
    
    // ã€æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼ã€‘
    if (!resp.ok) {
        const errorText = await resp.text();
        throw new Error(`HTTP éŒ¯èª¤: ${resp.status} - ${errorText.substring(0, 50)}`);
    }

    const j = await resp.json();
    if(j.status === 'ok'){
        
        // ã€ä½¿ç”¨ç´¢å¼•ç›´æ¥åœ¨åŸ buffer ä¸Šæ¨™è¨˜ sent=trueã€‘
        batchEntries.forEach(entry => {
            buffer[entry.index].sent = true;
        });
        
        saveLocalBuffer();
    
        const remainingToUpload = buffer.filter(item => !item.sent).length; 
        // ä¿®æ­£æ—¥èªŒï¼Œä½¿ç”¨ batchToSend.length é¡¯ç¤ºæˆåŠŸä¸Šå‚³ç­†æ•¸
        appendLog(`âœ… ä¸Šå‚³æˆåŠŸ ${batchToSend.length} ç­†, å‰©é¤˜å¾…ä¸Šå‚³: ${remainingToUpload} ç­† (ç¸½ç´€éŒ„æ•¸: ${buffer.length})`);
        
        updateScanList();

        // ã€é€£ç™¼æ©Ÿåˆ¶ã€‘
        if (remainingToUpload > 0) {
            setTimeout(sendBatch, 0); 
        }
        
        } else {
        appendLog('å¾Œç«¯å›å‚³éŒ¯èª¤: '+JSON.stringify(j));
    }
    }catch(err){
        appendLog(`ğŸ”´ ä¸Šå‚³å¤±æ•—ï¼Œç¨å¾Œé‡è©¦ã€‚éŒ¯èª¤é¡å‹: ${err.name} - ${err.message}`); 
        console.error(err); 
    } finally {
        // ç¢ºä¿ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œä¸Šå‚³ç‹€æ…‹æ——æ¨™éƒ½è¢«é‡ç½®
        sending = false;
    }
}

function startBatchTimer(){
stopBatchTimer();
timerId = setInterval(()=>{ sendBatch(); }, BATCH_TIMEOUT_MS);
}
function stopBatchTimer(){ if(timerId) clearInterval(timerId); timerId=null; }

// ã€æ–°å¢å‡½å¼ã€‘ å¾ GAS ç²å–å°ˆè»Šæ¸…å–®
async function loadTrucks() {
    appendLog('å˜—è©¦è¼‰å…¥å°ˆè»Šæ¸…å–®...');
    try {
        const truckEndpoint = GAS_ENDPOINT + '?action=getTrucks';
        const resp = await fetch(truckEndpoint);
        if (!resp.ok) {
            throw new Error(`HTTP éŒ¯èª¤: ${resp.status}`);
        }
        const j = await resp.json();
        
        whTruckNumberSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡å°ˆè»Š --</option>';

        if (j.status === 'ok' && j.trucks && j.trucks.length > 0) {
            j.trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck;
                option.textContent = truck;
                whTruckNumberSelect.appendChild(option);
            });
            appendLog(`æˆåŠŸè¼‰å…¥ ${j.trucks.length} å€‹å°ˆè»Šç·¨è™Ÿ`);
        } else {
            appendLog('å°ˆè»Šæ¸…å–®è¼‰å…¥å¤±æ•—æˆ–ç‚ºç©º: ' + (j.message || 'è«‹ç¢ºèª GAS è¨­ç½®'));
        }
    } catch (err) {
        appendLog('è¼‰å…¥å°ˆè»Šæ¸…å–®æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤');
        console.error(err);
        whTruckNumberSelect.innerHTML = '<option value="">-- è¼‰å…¥éŒ¯èª¤ --</option>';
    }
}

// ã€æ–°å¢å‡½å¼ã€‘ å¾ GAS ç²å–è³£å®¶æ¸…å–®ä¸¦å¡«å……ä¸‹æ‹‰é¸å–®
async function loadSellers(truckNumber) { 
    // appendLog('å˜—è©¦è¼‰å…¥è³£å®¶æ¸…å–®...');
    sellerSelect.innerHTML = '<option value="">-- è¼‰å…¥ä¸­... --</option>';
    appendLog(`å˜—è©¦è¼‰å…¥å°ˆè»Š [${truckNumber}] çš„è³£å®¶æ¸…å–®...`);
    try {
        const sellerEndpoint = `${GAS_ENDPOINT}?action=getSellers&truck=${encodeURIComponent(truckNumber)}`;
        const resp = await fetch(sellerEndpoint);
        
        if (!resp.ok) {
            throw new Error(`HTTP éŒ¯èª¤: ${resp.status}`);
        }
        
        const j = await resp.json();
        
        // æ¸…ç©ºä¸‹æ‹‰é¸å–®
        sellerSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡è³£å®¶ --</option>'; 

        if (j.status === 'ok' && j.sellers && j.sellers.length > 0) {
            j.sellers.forEach(seller => { // éæ­·è®Šæ•¸åç¨±ä¿®æ”¹
                const option = document.createElement('option');
                option.value = seller;
                option.textContent = seller;
                sellerSelect.appendChild(option);
            });
            appendLog(`å°ˆè»Š [${truckNumber}] æˆåŠŸè¼‰å…¥ ${j.sellers.length} å€‹è³£å®¶`);
        } else {
            // å¦‚æœæ¸…å–®ç‚ºç©ºæˆ–éŒ¯èª¤
            appendLog('è³£å®¶æ¸…å–®è¼‰å…¥å¤±æ•—æˆ–ç‚ºç©º: ' + (j.message || 'è«‹ç¢ºèª GAS è¨­ç½®'));
        }
    } catch (err) {
        appendLog('è¼‰å…¥è³£å®¶æ¸…å–®æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤');
        console.error(err);
        sellerSelect.innerHTML = '<option value="">-- è¼‰å…¥éŒ¯èª¤ --</option>'; 
    }
}

function playBeep() {
    // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ Audio
    if (typeof Audio === 'undefined') {
        console.warn('Audio API is not supported.');
        return;
    }

    if (!audio) {
        // ä½¿ç”¨ä¸€å€‹éå¸¸çŸ­ä¿ƒã€æ¨™æº–çš„å—¶å—¶è²MP3æ–‡ä»¶ (æ‚¨å¯ä»¥æ›¿æ›ç‚ºè‡ªå·±çš„éŸ³é »è·¯å¾‘)
        // ç‚ºäº†ç¢ºä¿èˆ‡æ‰€æœ‰ç€è¦½å™¨ç›¸å®¹ï¼Œä½¿ç”¨ base64 æ•¸æ“šæœƒæ›´å¯é ï¼Œä½†é€™è£¡ç¤ºç¯„ä½¿ç”¨æœ€å¸¸è¦‹çš„æª”æ¡ˆé¡å‹
        // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨äº†ä¸€å€‹å¸¸è¦‹çš„æ¨¡æ“¬å—¶å—¶è²çš„ç¶²è·¯è³‡æºä½œç‚ºç¯„ä¾‹ã€‚
        audio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
        // è¨­ç½®éŸ³é‡ï¼Œé¿å…è²éŸ³éå¤§
        audio.volume = 0.5; 
    }
    
    // é‡æ–°è¼‰å…¥ä¸¦æ’­æ”¾ (ç¢ºä¿åœ¨å¤šæ¬¡æƒæä¸­éƒ½èƒ½éŸ¿èµ·)
    audio.currentTime = 0; // å¾é ­é–‹å§‹æ’­æ”¾
    audio.play().catch(error => {
        // æ•æ‰ç€è¦½å™¨å¯èƒ½å› æ¬Šé™å•é¡Œé˜»æ­¢æ’­æ”¾çš„éŒ¯èª¤
        console.warn("ç„¡æ³•æ’­æ”¾éŸ³é » (å¯èƒ½éœ€è¦ç”¨æˆ¶äº’å‹•):", error);
    });
}

btnStart.addEventListener('click', ()=>{
// å¿…é ˆåŒæ™‚é¸æ“‡ å°ˆè»Šç·¨è™Ÿ ä¸”é¸æ“‡ Seller
if(!whTruckNumberSelect.value){Â 
Â  Â  alert('è«‹é¸æ“‡å°ˆè»Šç·¨è™Ÿ (Truck)');Â 
Â  Â  return;Â 
}
if(!sellerSelect.value){Â 
Â  Â  alert('è«‹é¸æ“‡è³£å®¶ Seller');Â 
Â  Â  return;Â 
}
if(html5QrScanner) return;
html5QrScanner = new Html5Qrcode("qr-reader");
html5QrScanner.start({ facingMode: 'environment' }, {
    fps: 10,
    qrbox: {width:250, height:250}
}, (decodedText, decodedResult)=>{
    statusEl.textContent = 'æƒåˆ°: '+decodedText;
    enqueue(decodedText);
}, (errorMessage) => {
    // parse errors or no result
}).then(()=>{
    appendLog('ç›¸æ©Ÿå•Ÿå‹•'); 
    statusEl.textContent='æƒæä¸­...';
    isScanning = true; // ã€ä¿®æ”¹é»ã€‘å•Ÿå‹•æƒæ
    btnSync.disabled = true; // ã€ä¿®æ”¹é»ã€‘æƒæå•Ÿå‹•æ™‚ç¦ç”¨ä¸Šå‚³
}).catch(err=>{ alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: '+err); });


startBatchTimer();
});

btnStop.addEventListener('click', ()=>{
    if(html5QrScanner){
        html5QrScanner.stop().then(()=>{
            html5QrScanner.clear(); 
            html5QrScanner=null; 
            appendLog('ç›¸æ©Ÿå·²åœæ­¢'); 
            statusEl.textContent='å·²åœæ­¢';
            isScanning = false; // ã€ä¿®æ”¹é»ã€‘åœæ­¢æƒæ
            btnSync.disabled = false; // ã€ä¿®æ”¹é»ã€‘åœæ­¢å¾Œå•Ÿç”¨ä¸Šå‚³
        }).catch(e=>console.error(e)); }
stopBatchTimer();
});


btnSync.addEventListener('click', ()=>{ 
    // ã€ä¿®æ”¹é»ã€‘å¦‚æœæ­£åœ¨æƒæï¼Œå½ˆå‡ºè­¦å‘Šä¸¦è¿”å›
    if(isScanning){
        alert('è«‹å…ˆé»æ“Šã€Œåœæ­¢ã€æŒ‰éˆ•çµæŸæƒæä½œæ¥­ï¼');
        return;
    }
    sendBatch();
});

// ã€æ–°å¢äº‹ä»¶ï¼šé¸æ“‡å°ˆè»Šç·¨è™Ÿå¾Œï¼Œè‡ªå‹•è¼‰å…¥è³£å®¶æ¸…å–®ã€‘
whTruckNumberSelect.addEventListener('change', () => {
    const selectedTruck = whTruckNumberSelect.value;
    if (selectedTruck) {
        // æ¸…ç©º sellerSelectï¼Œä¸¦è§¸ç™¼ loadSellers
        sellerSelect.innerHTML = '<option value="">-- è¼‰å…¥ä¸­... --</option>';
        loadSellers(selectedTruck);
    } else {
        sellerSelect.innerHTML = '<option value="">-- è«‹å…ˆé¸æ“‡å°ˆè»Š --</option>';
    }
    // æ­¤å¤–ï¼Œåˆ‡æ›å°ˆè»Š/è³£å®¶æ™‚æ¸…ç©º buffer çš„é‚è¼¯ä¹Ÿæ‡‰åœ¨é€™è£¡è§¸ç™¼
    if (buffer.length > 0) {
        // è§¸ç™¼åˆ‡æ›è³£å®¶æ¸…ç©ºè³‡æ–™çš„é‚è¼¯
        sellerSelect.dispatchEvent(new Event('change')); 
    }
});


// åˆå§‹è¼‰å…¥ï¼š
loadLocalBuffer(); // æ¢å¾©é›¢ç·šç·©å­˜
loadTrucks(); // âœ… ä¿®æ­£ï¼šå…ˆè¼‰å…¥å°ˆè»Šæ¸…å–®
// loadSellers(); // è¼‰å…¥è³£å®¶æ¸…å–®
// è‡ªå‹•é‡è©¦ä¸Šå‚³(ç¶²è·¯å¾©åŸæ™‚)
window.addEventListener('online', ()=>{ appendLog('ç¶²è·¯å›å¾©ï¼Œé–‹å§‹ä¸Šå‚³'); sendBatch(); });
// ã€ä¿®æ­£å€åŸŸ 2: æ–°å¢è³£å®¶åˆ‡æ›äº‹ä»¶ï¼Œæ¸…ç©ºè³‡æ–™ã€‘
sellerSelect.addEventListener('change', () => {
    // æª¢æŸ¥ç•¶å‰æ˜¯å¦æœ‰å·²è¨˜éŒ„çš„è³‡æ–™ï¼Œé¿å…åœ¨å•Ÿå‹•é é¢æ™‚åŸ·è¡Œæ¸…ç©ºå‹•ä½œ
    if (buffer.length > 0) {
        // 1. æ¸…ç©º buffer (è¨˜æ†¶é«”ä¸­çš„æƒæç´€éŒ„)
        buffer = []; 
        
        // 2. æ¸…ç©ºæœ¬åœ°å„²å­˜ (é›¢ç·šç·©å­˜)
        localStorage.removeItem(LOCAL_KEY);
        
        // 3. ç«‹å³æ›´æ–°è¡¨æ ¼å’Œè¨ˆæ•¸å™¨ï¼Œè®“é é¢æ­¸é›¶
        updateScanList();
        
        appendLog('ğŸ”„ è³£å®¶åˆ‡æ›å®Œæˆï¼Œæƒæç´€éŒ„å·²æ¸…ç©ºã€‚è«‹é–‹å§‹æƒææ–°çš„æ‰¹æ¬¡ã€‚');
        
        // 4. åœæ­¢è‡ªå‹•æ‰¹æ¬¡ä¸Šå‚³è¨ˆæ™‚å™¨
        stopBatchTimer(); 
        
        // 5. åœæ­¢æƒæä¸­çš„ç›¸æ©Ÿ (å»ºè­°æ“ä½œï¼Œç¢ºä¿é‚è¼¯æ¸…æ™°)
        if (html5QrScanner) {
            html5QrScanner.stop().then(() => {
                html5QrScanner.clear();
                html5QrScanner = null;
                appendLog('ç›¸æ©Ÿå·²è‡ªå‹•åœæ­¢ (åˆ‡æ›ä½œæ¥­)ã€‚');
                statusEl.textContent = 'å·²åœæ­¢ (åˆ‡æ›ä½œæ¥­)';
                isScanning = false;
                btnSync.disabled = false;
            }).catch(e => console.error(e));
        } else {
            // å¦‚æœç›¸æ©Ÿæ²’é–‹ï¼Œç¢ºä¿ä¸Šå‚³æŒ‰éˆ•å¯ç”¨
            btnSync.disabled = false;
        }
    }
});
</script>
</body>
</html>

